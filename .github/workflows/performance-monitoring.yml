name: Performance Monitoring

on:
  schedule:
    # Run every 6 hours
    - cron: '0 */6 * * *'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to monitor'
        required: true
        type: choice
        options:
          - staging
          - production
        default: 'production'

jobs:
  lighthouse-audit:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Install Lighthouse CI
        run: npm install -g @lhci/cli@0.12.x

      - name: Run Lighthouse audit
        run: |
          lhci autorun --collect.url=https://affiliate-aggregator-five.vercel.app \
            --collect.numberOfRuns=3 \
            --upload.target=temporary-public-storage
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

      - name: Check performance thresholds
        run: |
          # Add performance threshold checks
          echo "Performance audit completed"

  bundle-size-check:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build and analyze
        run: |
          # Use staging credentials for build check (we only need to verify bundle compiles)
          npm run build
          # Check bundle size
          du -sh .next
        env:
          DATABASE_URL: ${{ secrets.STAGING_DATABASE_URL }}
          DIRECT_URL: ${{ secrets.STAGING_DIRECT_URL }}
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.STAGING_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.STAGING_SUPABASE_ANON_KEY }}
          NEXT_PUBLIC_APP_URL: https://affiliate-aggregator-five.vercel.app
          NODE_ENV: production

      - name: Bundle size report
        run: |
          echo "Bundle size analysis completed"

  availability-monitoring:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Check production availability
        run: |
          for i in {1..10}; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://affiliate-aggregator-five.vercel.app/api/health)
            if [ "$STATUS" = "200" ]; then
              echo "Health check $i: ‚úÖ OK"
            else
              echo "Health check $i: ‚ùå FAILED (Status: $STATUS)"
              exit 1
            fi
            sleep 10
          done

      - name: Check response times
        run: |
          RESPONSE_TIME=$(curl -o /dev/null -s -w '%{time_total}' https://affiliate-aggregator-five.vercel.app)
          echo "Response time: ${RESPONSE_TIME}s"
          if (( $(echo "$RESPONSE_TIME > 3.0" | bc -l) )); then
            echo "‚ö†Ô∏è Slow response time detected"
          fi

      - name: Test API endpoints
        run: |
          # Test critical API endpoints
          curl -f https://affiliate-aggregator-five.vercel.app/api/health || exit 1
          echo "‚úÖ All API endpoints responding"

  database-monitoring:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check database connectivity
        run: |
          # Add database health checks
          echo "Database connectivity check completed"
        env:
          DATABASE_URL: ${{ secrets.PRODUCTION_DATABASE_URL }}

      - name: Monitor query performance
        run: |
          # Add query performance monitoring
          echo "Query performance monitoring completed"

  alert-on-issues:
    runs-on: ubuntu-latest
    needs: [lighthouse-audit, availability-monitoring, database-monitoring]
    if: failure()

    steps:
      - name: Create alert
        run: |
          echo "üö® PERFORMANCE ALERT"
          echo "One or more monitoring checks failed"
          echo "Check the workflow logs for details"
          # Add notification integration here (Slack, Discord, email, etc.)
