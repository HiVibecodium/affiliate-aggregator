// Prisma schema for Affiliate Aggregator

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// Affiliate Networks
model AffiliateNetwork {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  website     String?
  country     String?
  commission  Float?
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  programs           AffiliateProgram[]
  organizationAccess NetworkAccess[]

  @@index([country])
  @@index([active])
}

// Affiliate Programs
model AffiliateProgram {
  id               String   @id @default(cuid())
  networkId        String
  externalId       String // Unique identifier from the network
  name             String
  description      String?
  category         String?
  commissionRate   Float?
  commissionType   String? // CPA, CPS, CPL, etc.
  cookieDuration   Int? // in days
  paymentThreshold Float?
  paymentMethods   String[] // JSON array of payment methods
  // paymentFrequency String? // Payment schedule: "Daily", "Weekly", "NET-15", "NET-30", "Monthly" - TODO: Add after migration
  active           Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  network            AffiliateNetwork     @relation(fields: [networkId], references: [id], onDelete: Cascade)
  organizationAccess ProgramAccess[]
  favoredBy          Favorite[]
  clicks             ProgramClick[]
  reviews            ProgramReview[]
  applications       ProgramApplication[]

  @@unique([networkId, externalId])
  @@index([networkId])
  @@index([category])
  @@index([active])
  @@index([commissionType])
  @@index([commissionRate])
  // Composite indexes for common filter combinations (3-5x faster queries)
  @@index([active, category])
  @@index([active, networkId])
  @@index([active, commissionType])
  @@index([createdAt(sort: Desc)])
  // Additional composite indexes for complex filters (added 2025-11-15)
  @@index([active, category, commissionRate])
  @@index([active, networkId, category])
  @@index([networkId, category, commissionRate])
  // Text search optimization
  @@index([name])
  @@index([active, name])
  // Additional indexes for new filters (2025-11-15 evening)
  @@index([cookieDuration])
  @@index([paymentThreshold])
  @@index([active, cookieDuration])
  @@index([active, paymentThreshold])
  // @@index([paymentFrequency]) // TODO: Add after migration
  // @@index([active, paymentFrequency]) // TODO: Add after migration
}

// User tracking and authentication
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations for multi-tenancy
  organizationMembers OrganizationMember[]
  favorites           Favorite[]
  reviews             ProgramReview[]
  applications        ProgramApplication[]

  // Billing relations
  subscriptions  Subscription[]
  paymentMethods PaymentMethod[]
  invoices       Invoice[]
}

// Organization/Tenant model
model Organization {
  id          String  @id @default(cuid())
  name        String
  slug        String  @unique
  description String?
  logo        String?
  website     String?

  // Subscription and billing
  tier               String @default("free") // free, pro, enterprise
  subscriptionStatus String @default("active") // active, paused, cancelled

  // Organization settings
  settings Json? // Flexible settings storage

  // Timestamps
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  // Relations
  members       OrganizationMember[]
  programs      ProgramAccess[]
  networks      NetworkAccess[]
  subscriptions Subscription[]

  @@index([slug])
  @@index([tier])
  @@index([subscriptionStatus])
}

// Organization membership with role-based access
model OrganizationMember {
  id             String @id @default(cuid())
  organizationId String
  userId         String

  // Role assignment
  role String @default("member") // owner, admin, manager, member, viewer

  // Permissions override (for custom permissions)
  permissions String[] @default([]) // List of explicit permissions

  // Status and metadata
  status       String    @default("active") // active, pending, inactive
  invitedEmail String? // For pending invites
  // inviteToken  String?   @unique // Secure token for invite acceptance - TODO: Add after migration
  invitedAt    DateTime?
  acceptedAt   DateTime?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId])
  @@unique([organizationId, invitedEmail])
  @@index([organizationId])
  @@index([userId])
  @@index([role])
  @@index([status])
  // @@index([inviteToken]) // TODO: Add after migration
}

// Role-Permission mapping
model Role {
  id          String  @id @default(cuid())
  name        String  @unique
  description String?

  // Permissions for this role (array of permission keys)
  permissions String[] @default([])

  // System role flag
  isSystem Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isSystem])
}

// Data isolation: AffiliateNetwork access control
model NetworkAccess {
  id             String @id @default(cuid())
  organizationId String
  networkId      String

  // Access level
  accessLevel String @default("viewer") // viewer, manager, admin

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  network      AffiliateNetwork @relation(fields: [networkId], references: [id], onDelete: Cascade)

  @@unique([organizationId, networkId])
  @@index([organizationId])
  @@index([networkId])
}

// Data isolation: AffiliateProgram access control
model ProgramAccess {
  id             String @id @default(cuid())
  organizationId String
  programId      String

  // Access level
  accessLevel String @default("viewer") // viewer, manager, admin

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  program      AffiliateProgram @relation(fields: [programId], references: [id], onDelete: Cascade)

  @@unique([organizationId, programId])
  @@index([organizationId])
  @@index([programId])
}

// Audit log for organization actions
model AuditLog {
  id             String @id @default(cuid())
  organizationId String

  action       String // e.g., "user_added", "role_changed", "data_exported"
  resourceType String // e.g., "user", "program", "network"
  resourceId   String?

  performedBy String // userId
  details     Json? // Additional details about the action

  createdAt DateTime @default(now())

  @@index([organizationId])
  @@index([action])
  @@index([createdAt])
}

// User favorites/bookmarks for programs
model Favorite {
  id        String   @id @default(cuid())
  userId    String
  programId String
  createdAt DateTime @default(now())

  user    User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  program AffiliateProgram @relation(fields: [programId], references: [id], onDelete: Cascade)

  @@unique([userId, programId])
  @@index([userId])
  @@index([programId])
  @@index([createdAt])
}

// Click tracking for analytics
model ProgramClick {
  id        String   @id @default(cuid())
  programId String
  userId    String? // Optional - can track anonymous clicks
  userAgent String?
  referrer  String?
  ipAddress String?
  clickedAt DateTime @default(now())

  program AffiliateProgram @relation(fields: [programId], references: [id], onDelete: Cascade)

  @@index([programId])
  @@index([userId])
  @@index([clickedAt])
}

// Program Reviews - Community feedback system
model ProgramReview {
  id        String @id @default(cuid())
  programId String
  userId    String

  // Review content
  rating  Int // 1-5 stars
  title   String // Short review title
  content String // Full review text
  pros    String[] // Array of pros
  cons    String[] // Array of cons

  // Verification
  isVerified Boolean @default(false) // Verified affiliate badge
  experience String? // beginner, intermediate, advanced

  // Metrics (if user shares their data)
  monthsUsed    Int? // How long using the program
  earningsRange String? // e.g., "$100-500/mo", "$500-1000/mo"
  trafficSource String? // blog, youtube, social, email, etc.

  // Moderation
  status      String    @default("pending") // pending, approved, rejected, flagged
  moderatedBy String? // User ID of moderator
  moderatedAt DateTime?
  reportCount Int       @default(0)

  // Engagement
  helpfulCount    Int @default(0) // Upvotes
  notHelpfulCount Int @default(0) // Downvotes

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  program      AffiliateProgram @relation(fields: [programId], references: [id], onDelete: Cascade)
  user         User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  helpfulVotes ReviewHelpful[]
  reportedBy   ReviewReport[]

  @@unique([userId, programId]) // One review per user per program
  @@index([programId])
  @@index([userId])
  @@index([rating])
  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@index([helpfulCount(sort: Desc)]) // For "most helpful" sorting
}

// Review helpfulness votes
model ReviewHelpful {
  id       String  @id @default(cuid())
  reviewId String
  userId   String
  helpful  Boolean // true = helpful, false = not helpful

  createdAt DateTime @default(now())

  review ProgramReview @relation(fields: [reviewId], references: [id], onDelete: Cascade)

  @@unique([reviewId, userId]) // One vote per user per review
  @@index([reviewId])
  @@index([userId])
}

// Review reports (for moderation)
model ReviewReport {
  id       String @id @default(cuid())
  reviewId String
  userId   String

  reason  String // spam, inappropriate, fake, offensive, other
  details String?

  status     String    @default("pending") // pending, resolved, dismissed
  resolvedBy String?
  resolvedAt DateTime?

  createdAt DateTime @default(now())

  review ProgramReview @relation(fields: [reviewId], references: [id], onDelete: Cascade)

  @@unique([reviewId, userId]) // One report per user per review
  @@index([reviewId])
  @@index([userId])
  @@index([status])
}

// Program Applications - Track user applications to programs
model ProgramApplication {
  id        String @id @default(cuid())
  userId    String
  programId String

  // Application info
  status          String   @default("pending") // pending, approved, rejected, withdrawn
  appliedAt       DateTime @default(now())
  statusUpdatedAt DateTime @default(now())

  // Application details
  applicationUrl String? // Link to application if available
  affiliateId    String? // Assigned affiliate ID after approval
  notes          String? // User's private notes

  // Follow-up
  reminderDate DateTime? // When to follow up
  lastChecked  DateTime? // Last time user checked status

  // Performance tracking (optional, filled after approval)
  firstSaleDate DateTime? // When first sale was made
  totalEarnings Float?    @default(0)
  totalClicks   Int?      @default(0)
  totalSales    Int?      @default(0)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user    User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  program AffiliateProgram @relation(fields: [programId], references: [id], onDelete: Cascade)

  @@unique([userId, programId]) // One application per user per program
  @@index([userId])
  @@index([programId])
  @@index([status])
  @@index([appliedAt(sort: Desc)])
  @@index([reminderDate])
}

// ============================================================================
// BILLING & SUBSCRIPTION SYSTEM (Stripe Integration)
// ============================================================================

// Subscription management - Stripe subscription tracking
model Subscription {
  id             String  @id @default(cuid())
  userId         String
  organizationId String?

  // Stripe identifiers
  stripeCustomerId     String  @unique
  stripeSubscriptionId String? @unique
  stripePriceId        String?
  stripeProductId      String?

  // Subscription details
  tier   String @default("free") // free, pro, business, enterprise
  status String @default("active") // active, canceled, past_due, trialing, incomplete, incomplete_expired, unpaid

  // Billing period
  currentPeriodStart DateTime?
  currentPeriodEnd   DateTime?
  cancelAtPeriodEnd  Boolean   @default(false)
  canceledAt         DateTime?

  // Trial information
  trialStart DateTime?
  trialEnd   DateTime?

  // Metadata
  metadata Json? // Additional Stripe metadata

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  invoices     Invoice[]

  @@index([userId])
  @@index([organizationId])
  @@index([stripeCustomerId])
  @@index([status])
  @@index([tier])
  @@index([currentPeriodEnd]) // For expiration checks
}

// Payment methods - Stored Stripe payment methods
model PaymentMethod {
  id     String @id @default(cuid())
  userId String

  // Stripe identifier
  stripePaymentMethodId String @unique

  // Payment method details
  type  String // card, bank_account, etc.
  last4 String

  // Card-specific fields
  brand       String? // visa, mastercard, amex, etc.
  expiryMonth Int?
  expiryYear  Int?
  country     String?

  // Bank account-specific fields
  bankName     String?
  accountType  String? // checking, savings
  routingLast4 String?

  // Status
  isDefault Boolean @default(false)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isDefault])
}

// Invoices - Stripe invoice tracking
model Invoice {
  id             String  @id @default(cuid())
  userId         String
  subscriptionId String?

  // Stripe identifier
  stripeInvoiceId String @unique

  // Invoice details
  amount      Float
  currency    String  @default("usd")
  status      String // draft, open, paid, void, uncollectible
  description String?

  // Invoice URLs
  hostedInvoiceUrl String?
  invoicePdf       String?

  // Dates
  paidAt  DateTime?
  dueDate DateTime?

  // Period covered
  periodStart DateTime?
  periodEnd   DateTime?

  // Metadata
  metadata Json?

  // Timestamps
  createdAt DateTime @default(now())

  // Relations
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  subscription Subscription? @relation(fields: [subscriptionId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([subscriptionId])
  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@index([dueDate])
}

// Usage metrics - Track feature usage for tier limits
model UsageMetric {
  id     String @id @default(cuid())
  userId String

  // Metric details
  metric String // favorites_count, comparisons_daily, api_calls_monthly, etc.
  value  Int    @default(0)

  // Period tracking
  period String   @default("daily") // daily, weekly, monthly, lifetime
  date   DateTime @default(now())

  // Reset information
  resetAt    DateTime?
  lastReset  DateTime?
  resetCount Int       @default(0)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, metric, period, date])
  @@index([userId])
  @@index([userId, metric])
  @@index([date])
  @@index([resetAt])
}

// Coupon codes - Discount codes and promotions
model Coupon {
  id String @id @default(cuid())

  // Stripe identifier
  stripeCouponId String? @unique

  // Coupon details
  code        String  @unique
  name        String?
  description String?

  // Discount
  percentOff Int? // 10 = 10% off
  amountOff  Float? // Fixed amount off
  currency   String? @default("usd")

  // Restrictions
  maxRedemptions  Int?
  timesRedeemed   Int       @default(0)
  validFrom       DateTime  @default(now())
  validUntil      DateTime?
  firstTimeOnly   Boolean   @default(false)
  minimumAmount   Float?
  applicableTiers String[]  @default([]) // Which tiers can use this

  // Status
  active Boolean @default(true)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  redemptions CouponRedemption[]

  @@index([code])
  @@index([active])
  @@index([validUntil])
}

// Coupon redemptions - Track who used which coupons
model CouponRedemption {
  id       String @id @default(cuid())
  couponId String
  userId   String

  // Redemption details
  discountAmount Float
  appliedTo      String? // subscription, invoice

  // Stripe reference
  stripePromotionCodeId String?

  // Timestamps
  redeemedAt DateTime @default(now())

  // Relations
  coupon Coupon @relation(fields: [couponId], references: [id], onDelete: Cascade)

  @@index([couponId])
  @@index([userId])
  @@index([redeemedAt])
}

// Billing events - Audit trail for all billing actions
model BillingEvent {
  id     String @id @default(cuid())
  userId String

  // Event details
  type        String // subscription_created, payment_succeeded, payment_failed, etc.
  description String?
  status      String // success, failed, pending

  // Associated resources
  subscriptionId  String?
  invoiceId       String?
  paymentMethodId String?

  // Stripe event
  stripeEventId String? @unique

  // Event data
  eventData Json?

  // Error tracking
  errorMessage String?
  errorCode    String?

  // Timestamps
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([type])
  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@index([subscriptionId])
}

// Referrals - Track referral program
model Referral {
  id         String  @id @default(cuid())
  referrerId String // User who referred
  referredId String? // User who was referred (null until they sign up)

  // Referral details
  referralCode String  @unique
  email        String? // Email of referred user (before signup)
  status       String  @default("pending") // pending, completed, rewarded

  // Rewards
  referrerReward String? // e.g., "1_month_free", "$10_credit"
  referredReward String?
  rewardApplied  Boolean @default(false)

  // Conversion tracking
  signedUpAt  DateTime?
  convertedAt DateTime? // When referred user became paid

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([referrerId])
  @@index([referredId])
  @@index([referralCode])
  @@index([status])
  @@index([createdAt(sort: Desc)])
}

// Credits - Account credits/balance system
model Credit {
  id     String @id @default(cuid())
  userId String

  // Credit details
  amount      Float
  currency    String  @default("usd")
  description String?
  source      String? // referral, promotion, refund, etc.

  // Usage
  applied   Boolean   @default(false)
  appliedTo String? // invoice_id or subscription_id
  appliedAt DateTime?

  // Expiration
  expiresAt DateTime?

  // Timestamps
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([applied])
  @@index([expiresAt])
  @@index([createdAt(sort: Desc)])
}

// ============================================================================
// SAVED SEARCHES & ALERTS
// ============================================================================

// Saved searches with email alerts
model SavedSearch {
  id     String @id @default(cuid())
  userId String

  // Search details
  name        String
  description String?

  // Filter criteria (JSON)
  filters Json

  // Alert settings
  alertsEnabled     Boolean  @default(true)
  alertFrequency    String   @default("daily") // instant, daily, weekly
  lastAlertSent     DateTime?
  lastCheckedAt     DateTime?
  newMatchesCount   Int      @default(0)

  // Metadata
  timesExecuted Int      @default(0)
  lastExecutedAt DateTime?

  // Status
  active Boolean @default(true)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([userId, active])
  @@index([alertsEnabled])
  @@index([lastCheckedAt])
}
